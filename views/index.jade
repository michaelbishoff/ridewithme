extends layout

block additional_nav_items
  form.navbar-form.navbar-right
    .form-group
      label(for="from") From
      input.form-control(type="text", name="from", id="from")
    .form-group
      label(for="to") To
      input.form-control(type="text", name="to", id="to")
    button.btn.btn-primary#submitRoute(type="submit") Submit

block content
  .container#hypercontainer
    h1 Map
    #hypermap
    h1 Preview
    #hyperlapse

block extra_scripts
  script(src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places")
  script(src="/javascripts/GSVPano.min.js")
  script(src="/javascripts/three.min.js")
  script(src="/javascripts/hyperlapse.min.js")
  script(src="https://cdn.socket.io/socket.io-1.3.5.js")
  script.
    function testAjax() {
      $.get('/createvideo/4a9ccaf2-7482-d3b1-7c1b-efd7fa868b8f', function(data) {
        console.log(data);
      });  
    }

    testAjax();

    var hyperlapse;
    var directionsDisplay;
    var directionsService = new google.maps.DirectionsService();

    var socket = io.connect('http://localhost:3000');

    function getLoc(next) {
      var geoSuccess = function(position) {
        initialLoc = position;
        next();
      }

      // initial loc
      navigator.geolocation.getCurrentPosition(geoSuccess);
    }
    
    function initialize() {
      var from_autocomplete = new google.maps.places.Autocomplete(
        document.getElementById('from'), 
        { types: ['(cities)'], }
      );

      var to_autocomplete = new google.maps.places.Autocomplete(
        document.getElementById('to'), 
        { types: ['(cities)'], }
      );

      // map
      map = new google.maps.Map(document.getElementById('hypermap'), {
        zoom: 10,
        center: new google.maps.LatLng(initialLoc.coords.latitude, initialLoc.coords.longitude),
      });

      // directions
      directionsDisplay = new google.maps.DirectionsRenderer();
      directionsDisplay.setMap(map);

      hyperlapse = new Hyperlapse(document.getElementById('hyperlapse'), {
        zoom: 1,
        elevation: 50,
        max_points: 200,
        width: 593,
        height: 867,
      });

      hyperlapse.uniqueName = guidGenerator();

      hyperlapse.onError = function(e) {
        console.log(e);
      };

      hyperlapse.onRouteComplete = function(e) {
        hyperlapse.load();
      };

      hyperlapse.onLoadComplete = function(e) {
        hyperlapse.play();
      };

      hyperlapse.onSaveFramesComplete = function(name) {
        console.log('trying to create the video.');
        // make an ajax request to stich the videos together
        $.get('/stitch/' + name, function(data) {
          console.log(data);
        });  
      };

      hyperlapse.onPause = function(e) {
        console.log('on pause client');
      }
    }

    google.maps.event.addDomListener(window, 'load', getLoc(initialize));

    function calcRoute() {
      var start = document.getElementById('from').value;
      var end = document.getElementById('to').value;

      var request = {
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.DRIVING
      };
      
      directionsService.route(request, function(response, status) {
        if (status == google.maps.DirectionsStatus.OK) {
          directionsDisplay.setDirections(response); 
          hyperlapse.generate( {route:response} );    
        }
      });
    }

    $('#submitRoute').click(function(event) {
      event.preventDefault();
      calcRoute();
    });

    function guidGenerator() {
      var S4 = function() {
        return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
      };
      return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
    }